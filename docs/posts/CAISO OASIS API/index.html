<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Ryan McManus">
<meta name="dcterms.date" content="2023-11-01">
<title>Ryan McManus - CAISO OASIS API</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../images/profile.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><link rel="stylesheet" href="../../styles.css">
</head>
<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg navbar-dark "><div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Ryan McManus</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item">
    <a class="nav-link" href="../../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../projects.html" rel="" target="">
 <span class="menu-text">Projects</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../resume.html" rel="" target="">
 <span class="menu-text">Resume</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html" rel="" target="">
 <span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://ryanmcmanus916.github.io/leaflet-maps-with-google-sheets/" rel="" target="">
 <span class="menu-text">WEI Map</span></a>
  </li>  
</ul>
<ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item compact">
    <a class="nav-link" href="https://github.com/" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/ryan-mcmanus-energy" rel="" target=""><i class="bi bi-linkedin" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
<div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><header id="title-block-header" class="quarto-title-block default page-columns page-full"><div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">CAISO OASIS API</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">R</div>
                <div class="quarto-category">function</div>
                <div class="quarto-category">code</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Ryan McManus </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">November 1, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content"><p>For this post we’ll walk through creating an API function for downloading CAISO OASIS data through their supported API. I will be referencing the <a href="https://www.caiso.com/Documents/OASISAPISpecification.pdf" title="API Doc">Interface Specification for OASIS</a>. This document walks you through how to query the back-end system to extract a variety of data. Today we’ll be looking to get access to their day-ahead, fifteen minute, and real-time markets.</p>
<p>I will be using the single reports, as described in section 2.1. The basic format goes as followed:</p>
<p><code>URL?queryname=&amp;startdate=&amp;enddate=&amp;market_run_id=&amp;varParameters</code></p>
<p>Updated info –https://www.caiso.com/Documents/OASIS-Frequently-Asked-Questions.pdf</p>
<p>Assemble our variables…</p>
<p>Let’s setup the initial variables for the query.</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.3     ✔ readr     2.1.4
✔ forcats   1.0.0     ✔ stringr   1.5.0
✔ ggplot2   3.4.4     ✔ tibble    3.2.1
✔ lubridate 1.9.3     ✔ tidyr     1.3.0
✔ purrr     1.0.2     
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://httr.r-lib.org/">httr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://www.omegahat.net/RSXML/">XML</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">startdate</span><span class="op">&lt;-</span><span class="st">'2023-01-15'</span></span>
<span><span class="va">enddate</span><span class="op">&lt;-</span><span class="st">'2023-01-30'</span></span>
<span><span class="va">market_run_id</span><span class="op">&lt;-</span><span class="st">'RTM'</span></span>
<span><span class="va">api_version</span><span class="op">&lt;-</span><span class="fl">2</span></span>
<span><span class="va">queryname</span><span class="op">&lt;-</span><span class="st">'PRC_INTVL_LMP'</span></span>
<span><span class="va">nodes</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'TH_NP15_GEN-APND'</span>,<span class="st">'TH_SP15_GEN-APND'</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>This API requires a string of nodes be provided to the call. The function below will concatenate our vector string of nodes.</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">concat_nodes</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span><span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">&gt;</span><span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span> <span class="va">output</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">x</span>,collapse<span class="op">=</span><span class="st">","</span><span class="op">)</span> </span>
<span><span class="op">}</span><span class="kw">else</span><span class="op">{</span><span class="va">output</span><span class="op">=</span><span class="va">x</span><span class="op">}</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">output</span><span class="op">)</span><span class="op">}</span></span>
<span></span>
<span><span class="fu">concat_nodes</span><span class="op">(</span><span class="va">nodes</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] "TH_NP15_GEN-APND,TH_SP15_GEN-APND"</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">nodes</span><span class="op">&lt;-</span><span class="fu">concat_nodes</span><span class="op">(</span><span class="va">nodes</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The CAISO API requires an ISOFormat for its date input. The function below takes a more common R format and converts it to the necessary ISO format. It should be noted that the minimum query length is one day. If querying part days is necessary then this function could be altered to include a datetime “hour”.</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">caisodatefmt</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/utils/URLencode.html">URLencode</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,tz<span class="op">=</span><span class="st">"America/Los_Angeles"</span><span class="op">)</span>,<span class="st">"%Y%m%dT07:00-0000"</span><span class="op">)</span>,reserved <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">}</span></span>
<span><span class="va">isostartdate</span><span class="op">&lt;-</span><span class="fu">caisodatefmt</span><span class="op">(</span><span class="va">startdate</span><span class="op">)</span></span>
<span><span class="va">isoenddate</span><span class="op">&lt;-</span><span class="fu">caisodatefmt</span><span class="op">(</span><span class="va">enddate</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>This code section will be used to save the zipped file name. This will be important because we will be creating a loop to drop multiple files into our temp folder for extraction.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">response</span><span class="op">$</span><span class="va">headers</span><span class="op">$</span><span class="va">`content-disposition`</span><span class="op">)</span></span>
<span><span class="va">content_disposition</span><span class="op">&lt;-</span><span class="va">response</span><span class="op">$</span><span class="va">headers</span><span class="op">$</span><span class="va">`content-disposition`</span></span>
<span> <span class="va">filename</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">sub</a></span><span class="op">(</span><span class="st">"^.*filename=\"?([^;\"]+)\"?.*$"</span>, <span class="st">"\\1"</span>, <span class="va">content_disposition</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If you’d like you can delete the temp folder then all calculations are complete. This part has been removed in the final API because it can only be called once per R session.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/unlink.html">unlink</a></span><span class="op">(</span><span class="va">temp_dir</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The script below is a sample that takes a date range and a desired length of days and creates a range between the start and end dates.</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org">lubridate</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="st">'2022-01-01'</span><span class="op">)</span></span>
<span><span class="va">e</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="st">'2023-01-01'</span><span class="op">)</span></span>
<span><span class="va">day_chunk</span><span class="op">&lt;-</span><span class="fl">30</span></span>
<span></span>
<span><span class="kw">while</span> <span class="op">(</span><span class="va">s</span> <span class="op">&lt;=</span> <span class="va">e</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">e_tmp</span> <span class="op">&lt;-</span> <span class="va">s</span> <span class="op">+</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html">days</a></span><span class="op">(</span><span class="va">day_chunk</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">e_tmp</span> <span class="op">&gt;</span> <span class="va">e</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">e_tmp</span> <span class="op">&lt;-</span> <span class="va">e</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Start Date:"</span>, <span class="va">s</span>, <span class="st">"End Date:"</span>, <span class="va">e_tmp</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">s</span> <span class="op">&lt;-</span> <span class="va">e_tmp</span> <span class="op">+</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html">days</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] "Start Date: 2022-01-01 End Date: 2022-01-31"
[1] "Start Date: 2022-02-01 End Date: 2022-03-03"
[1] "Start Date: 2022-03-04 End Date: 2022-04-03"
[1] "Start Date: 2022-04-04 End Date: 2022-05-04"
[1] "Start Date: 2022-05-05 End Date: 2022-06-04"
[1] "Start Date: 2022-06-05 End Date: 2022-07-05"
[1] "Start Date: 2022-07-06 End Date: 2022-08-05"
[1] "Start Date: 2022-08-06 End Date: 2022-09-05"
[1] "Start Date: 2022-09-06 End Date: 2022-10-06"
[1] "Start Date: 2022-10-07 End Date: 2022-11-06"
[1] "Start Date: 2022-11-07 End Date: 2022-12-07"
[1] "Start Date: 2022-12-08 End Date: 2023-01-01"</code></pre>
</div>
</div>
<p>The API call below is where the rubber meets the road. This script is doing three key things.</p>
<ol type="1">
<li><p>Its querying the CAISO API and returning a response.</p></li>
<li><p>Its saving the returned zipped XML file to a temporary file.</p></li>
<li><p>Its unzipping the downloaded XML file and loading it to a dataframe.</p></li>
</ol>
<p>If it seems like a lot, it’s because it is…</p>
<p>This query is looking for an XML file, which is CAISO’s preferred format. There is an option for a zipped CSV file. Simply add <code>resultformat=6</code> to the params list.</p>
<p>Each query has a different maximum date length you can request. This depends on the granularity of the data being requested. Since we will probably need more than ~30days of data we will need to implement a loop into our query.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">startdate</span><span class="op">&lt;-</span><span class="st">'2023-01-01'</span> <span class="co">#Date string in format %Y-%m-%d</span></span>
<span><span class="va">enddate</span><span class="op">&lt;-</span><span class="st">'2023-01-31'</span> <span class="co">#Date string in format %Y-%m-%d</span></span>
<span><span class="va">query</span><span class="op">&lt;-</span><span class="st">'DAM'</span> <span class="co"># one of Day Ahead='DAM', 15Min Market='FMM', Real Time='RTM'</span></span>
<span><span class="va">day_chunk</span><span class="op">&lt;-</span><span class="fl">30</span> <span class="co"># Default is 30days, but can be adjusted</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://httr.r-lib.org/">httr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://www.omegahat.net/RSXML/">XML</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://xml2.r-lib.org/">xml2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">caiso_prices</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">startdate</span>,<span class="va">enddate</span>,<span class="va">query</span>,<span class="va">nodes</span>,<span class="va">day_chunk</span><span class="op">=</span><span class="fl">30</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>  <span class="va">concat_nodes</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span><span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">&gt;</span><span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>   <span class="va">output</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">x</span>,collapse<span class="op">=</span><span class="st">","</span><span class="op">)</span> </span>
<span>  <span class="op">}</span><span class="kw">else</span><span class="op">{</span><span class="va">output</span><span class="op">=</span><span class="va">x</span><span class="op">}</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">output</span><span class="op">)</span><span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">nodes</span><span class="op">&lt;-</span><span class="fu">concat_nodes</span><span class="op">(</span><span class="va">nodes</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">startdate</span><span class="op">&lt;-</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="va">startdate</span><span class="op">)</span></span>
<span>  <span class="va">enddate</span><span class="op">&lt;-</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="va">enddate</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">df_output</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="co">#Dataframe to store all looped dataframes</span></span>
<span>  </span>
<span>  <span class="co"># If statement to assign API specific variables</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">query</span><span class="op">==</span><span class="st">'DAM'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">queryname</span><span class="op">&lt;-</span><span class="st">'PRC_LMP'</span></span>
<span>    <span class="va">api_version</span><span class="op">&lt;-</span><span class="fl">12</span></span>
<span>    <span class="va">market_run_id</span><span class="op">&lt;-</span><span class="st">'DAM'</span></span>
<span>  <span class="op">}</span><span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">query</span><span class="op">==</span><span class="st">'RTM'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">queryname</span><span class="op">&lt;-</span><span class="st">'PRC_INTVL_LMP'</span></span>
<span>    <span class="va">api_version</span><span class="op">&lt;-</span><span class="fl">2</span></span>
<span>    <span class="va">market_run_id</span><span class="op">&lt;-</span><span class="st">'RTM'</span></span>
<span>  <span class="op">}</span><span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">query</span><span class="op">==</span><span class="st">'FMM'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">queryname</span><span class="op">&lt;-</span><span class="st">'PRC_RTPD_LMP'</span></span>
<span>    <span class="va">api_version</span><span class="op">&lt;-</span><span class="fl">3</span></span>
<span>    <span class="va">market_run_id</span><span class="op">&lt;-</span><span class="st">'RTPD'</span></span>
<span>  <span class="op">}</span><span class="kw">else</span><span class="op">{</span></span>
<span>    <span class="va">api_version</span><span class="op">&lt;-</span><span class="fl">1</span></span>
<span>    <span class="va">market_run_id</span><span class="op">&lt;-</span><span class="st">'DAM'</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Loop over desired date ranges</span></span>
<span>  <span class="kw">while</span> <span class="op">(</span><span class="va">startdate</span> <span class="op">&lt;=</span> <span class="va">enddate</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">e_tmp</span> <span class="op">&lt;-</span> <span class="va">startdate</span> <span class="op">+</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html">days</a></span><span class="op">(</span><span class="va">day_chunk</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">e_tmp</span> <span class="op">&gt;</span> <span class="va">enddate</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">e_tmp</span> <span class="op">&lt;-</span> <span class="va">enddate</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="co"># Convert dates to CAISO preferred format</span></span>
<span>      <span class="va">caisodatefmt</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,tz<span class="op">=</span><span class="st">"America/Los_Angeles"</span><span class="op">)</span>,<span class="st">"%Y%m%dT07:00-0000"</span><span class="op">)</span><span class="op">)</span><span class="op">}</span></span>
<span>      <span class="va">isostartdate</span><span class="op">&lt;-</span><span class="fu">caisodatefmt</span><span class="op">(</span><span class="va">startdate</span><span class="op">)</span></span>
<span>      <span class="va">isoenddate</span><span class="op">&lt;-</span><span class="fu">caisodatefmt</span><span class="op">(</span><span class="va">e_tmp</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="va">endpoint</span> <span class="op">&lt;-</span> <span class="st">'http://oasis.caiso.com/oasisapi/SingleZip'</span></span>
<span>      </span>
<span>      <span class="co"># Define the parameters for the data you want to retrieve</span></span>
<span>      <span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>       <span class="co"># "resultformat"=6,</span></span>
<span>        <span class="st">"queryname"</span> <span class="op">=</span> <span class="va">queryname</span>, <span class="co"># Query Name</span></span>
<span>        <span class="st">"version"</span> <span class="op">=</span> <span class="va">api_version</span>, <span class="co"># API version</span></span>
<span>        <span class="st">"startdatetime"</span> <span class="op">=</span> <span class="va">isostartdate</span>,  <span class="co"># Start date and time</span></span>
<span>        <span class="st">"enddatetime"</span> <span class="op">=</span> <span class="va">isoenddate</span>,    <span class="co"># End date and time</span></span>
<span>        <span class="st">"market_run_id"</span> <span class="op">=</span> <span class="va">market_run_id</span>,  <span class="co"># Desired Market</span></span>
<span>        <span class="st">"node"</span> <span class="op">=</span> <span class="va">nodes</span> <span class="co"># Concatenated list of nodes</span></span>
<span>      <span class="op">)</span></span>
<span>      </span>
<span>      <span class="co"># Make the API request with parameters</span></span>
<span>      <span class="va">full_url</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/utils/URLencode.html">URLdecode</a></span><span class="op">(</span><span class="fu"><a href="https://httr.r-lib.org/reference/modify_url.html">modify_url</a></span><span class="op">(</span><span class="va">endpoint</span>, query <span class="op">=</span> <span class="va">params</span><span class="op">)</span><span class="op">)</span> <span class="co"># This is here to make sure the ":" render correctly</span></span>
<span>      <span class="va">response</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://httr.r-lib.org/reference/GET.html">GET</a></span><span class="op">(</span><span class="va">full_url</span><span class="op">)</span></span>
<span>      </span>
<span>      </span>
<span>      <span class="co"># Check if the request was successful (status code 200)</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="va">response</span><span class="op">$</span><span class="va">status_code</span> <span class="op">==</span> <span class="fl">200</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="co">#Create and store zipped file</span></span>
<span>        <span class="va">temp_dir</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span><span class="op">(</span><span class="op">)</span></span>
<span>        <span class="va">content_disposition</span><span class="op">&lt;-</span><span class="va">response</span><span class="op">$</span><span class="va">headers</span><span class="op">$</span><span class="va">`content-disposition`</span></span>
<span>        <span class="va">filename</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">sub</a></span><span class="op">(</span><span class="st">"^.*filename=\"?([^;\"]+)\"?.*$"</span>, <span class="st">"\\1"</span>, <span class="va">content_disposition</span><span class="op">)</span></span>
<span>        <span class="va">temp_zip_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">temp_dir</span>, <span class="st">"\\"</span>, <span class="va">filename</span><span class="op">)</span></span>
<span>       </span>
<span>        <span class="va">zipped</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/readBin.html">writeBin</a></span><span class="op">(</span><span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="va">response</span>,as<span class="op">=</span><span class="st">'raw'</span><span class="op">)</span>,<span class="va">temp_zip_file</span><span class="op">)</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/utils/unzip.html">unzip</a></span><span class="op">(</span><span class="va">temp_zip_file</span>,exdir<span class="op">=</span><span class="va">temp_dir</span><span class="op">)</span></span>
<span>        <span class="va">extracted_files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="va">temp_dir</span><span class="op">)</span></span>
<span>        </span>
<span>        <span class="va">data_file</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">temp_dir</span>,<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu">tools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/tools/fileutils.html">file_path_sans_ext</a></span><span class="op">(</span><span class="va">filename</span><span class="op">)</span>,<span class="st">'.xml'</span><span class="op">)</span><span class="op">)</span> <span class="co"># Specific file pulled. Temp folder may have many.</span></span>
<span>        <span class="co"># Parse XML</span></span>
<span>        <span class="va">xml_doc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/XML/man/xmlTreeParse.html">xmlParse</a></span><span class="op">(</span><span class="va">data_file</span><span class="op">)</span></span>
<span>        <span class="va">root_element</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/XML/man/xmlRoot.html">xmlRoot</a></span><span class="op">(</span><span class="va">xml_doc</span><span class="op">)</span></span>
<span>        </span>
<span>        <span class="co"># Get the namespace URI</span></span>
<span>        <span class="va">namespace_uri</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/XML/man/xmlNamespace.html">xmlNamespace</a></span><span class="op">(</span><span class="va">root_element</span><span class="op">)</span></span>
<span>        </span>
<span>        <span class="co"># Define the namespace prefix and URI</span></span>
<span>        <span class="va">namespace_prefix</span> <span class="op">&lt;-</span> <span class="st">"ns"</span></span>
<span>        <span class="va">namespace_uri</span> <span class="op">&lt;-</span> <span class="va">namespace_uri</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>        </span>
<span>        <span class="co"># Find all &lt;REPORT_DATA&gt; elements with the namespace</span></span>
<span>        <span class="va">report_data_nodes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/XML/man/getNodeSet.html">getNodeSet</a></span><span class="op">(</span><span class="va">xml_doc</span>, <span class="st">"//ns:REPORT_DATA"</span>, namespaces <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>ns <span class="op">=</span> <span class="va">namespace_uri</span><span class="op">)</span><span class="op">)</span></span>
<span>        </span>
<span>        <span class="co"># Convert the XML data to a data frame</span></span>
<span>        <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/XML/man/xmlToDataFrame.html">xmlToDataFrame</a></span><span class="op">(</span><span class="va">report_data_nodes</span><span class="op">)</span></span>
<span>        </span>
<span>        <span class="va">df_output</span><span class="op">&lt;-</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">df_output</span>,<span class="va">df</span><span class="op">)</span> <span class="co">#combine all results </span></span>
<span>        </span>
<span>      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"API request was not successful."</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">'Range start:'</span>,<span class="va">startdate</span>,<span class="st">' end:'</span>,<span class="va">e_tmp</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">startdate</span> <span class="op">&lt;-</span> <span class="va">e_tmp</span> <span class="op">+</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html">days</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="co"># Increment loop by 1 day</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html">Sys.sleep</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span> <span class="co">#Sleep so you dont ping the server to death</span></span>
<span>    <span class="op">}</span> <span class="co">#end of while loop</span></span>
<span>  <span class="co">#unlink(temp_dir, recursive = TRUE) # Currently not used</span></span>
<span>  </span>
<span>  <span class="co">#Convert the GMT or UTC times to the local timezone. </span></span>
<span>  <span class="va">df_output</span><span class="op">&lt;-</span><span class="va">df_output</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>      START_DATETIME<span class="op">=</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/with_tz.html">with_tz</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="va">INTERVAL_START_GMT</span>, <span class="st">"%Y-%m-%dT%H:%M:%S"</span>, tz<span class="op">=</span><span class="st">"UTC"</span><span class="op">)</span>,tzone<span class="op">=</span><span class="st">"America/Los_Angeles"</span><span class="op">)</span>,</span>
<span>           END_DATETIME<span class="op">=</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/with_tz.html">with_tz</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="va">INTERVAL_END_GMT</span>, <span class="st">"%Y-%m-%dT%H:%M:%S"</span>, tz<span class="op">=</span><span class="st">"UTC"</span><span class="op">)</span>,tzone<span class="op">=</span><span class="st">"America/Los_Angeles"</span><span class="op">)</span>,.after<span class="op">=</span><span class="va">INTERVAL_END_GMT</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">df_output</span><span class="op">)</span> <span class="co"># Final output to return</span></span>
<span><span class="op">}</span><span class="co">#end of function</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Take our new function for a spin…</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">startdate</span><span class="op">&lt;-</span><span class="st">'2023-01-15'</span></span>
<span><span class="va">enddate</span><span class="op">&lt;-</span><span class="st">'2023-01-16'</span></span>
<span><span class="va">query</span><span class="op">&lt;-</span><span class="st">'RTM'</span> </span>
<span><span class="va">nodes</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'TH_NP15_GEN-APND'</span>,<span class="st">'TH_SP15_GEN-APND'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">result</span><span class="op">&lt;-</span><span class="fu">caiso_prices</span><span class="op">(</span>startdate <span class="op">=</span> <span class="va">startdate</span>,enddate<span class="op">=</span><span class="va">enddate</span>,query <span class="op">=</span> <span class="va">query</span>,nodes <span class="op">=</span> <span class="va">nodes</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] "Range start: 2023-01-15  end: 2023-01-16"</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">result</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>      DATA_ITEM    RESOURCE_NAME   OPR_DATE INTERVAL_NUM
1  LMP_CONG_PRC TH_NP15_GEN-APND 2023-01-14          277
2  LMP_CONG_PRC TH_NP15_GEN-APND 2023-01-14          278
3  LMP_CONG_PRC TH_NP15_GEN-APND 2023-01-14          279
4  LMP_CONG_PRC TH_NP15_GEN-APND 2023-01-14          280
5  LMP_CONG_PRC TH_NP15_GEN-APND 2023-01-14          281
6  LMP_CONG_PRC TH_NP15_GEN-APND 2023-01-14          282
7  LMP_CONG_PRC TH_NP15_GEN-APND 2023-01-14          283
8  LMP_CONG_PRC TH_NP15_GEN-APND 2023-01-14          284
9  LMP_CONG_PRC TH_NP15_GEN-APND 2023-01-14          285
10 LMP_CONG_PRC TH_NP15_GEN-APND 2023-01-14          286
          INTERVAL_START_GMT          INTERVAL_END_GMT      START_DATETIME
1  2023-01-15T07:00:00-00:00 2023-01-15T07:05:00-00:00 2023-01-14 23:00:00
2  2023-01-15T07:05:00-00:00 2023-01-15T07:10:00-00:00 2023-01-14 23:05:00
3  2023-01-15T07:10:00-00:00 2023-01-15T07:15:00-00:00 2023-01-14 23:10:00
4  2023-01-15T07:15:00-00:00 2023-01-15T07:20:00-00:00 2023-01-14 23:15:00
5  2023-01-15T07:20:00-00:00 2023-01-15T07:25:00-00:00 2023-01-14 23:20:00
6  2023-01-15T07:25:00-00:00 2023-01-15T07:30:00-00:00 2023-01-14 23:25:00
7  2023-01-15T07:30:00-00:00 2023-01-15T07:35:00-00:00 2023-01-14 23:30:00
8  2023-01-15T07:35:00-00:00 2023-01-15T07:40:00-00:00 2023-01-14 23:35:00
9  2023-01-15T07:40:00-00:00 2023-01-15T07:45:00-00:00 2023-01-14 23:40:00
10 2023-01-15T07:45:00-00:00 2023-01-15T07:50:00-00:00 2023-01-14 23:45:00
          END_DATETIME VALUE
1  2023-01-14 23:05:00     0
2  2023-01-14 23:10:00     0
3  2023-01-14 23:15:00     0
4  2023-01-14 23:20:00     0
5  2023-01-14 23:25:00     0
6  2023-01-14 23:30:00     0
7  2023-01-14 23:35:00     0
8  2023-01-14 23:40:00     0
9  2023-01-14 23:45:00     0
10 2023-01-14 23:50:00     0</code></pre>
</div>
</div>



</main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'alternate';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>